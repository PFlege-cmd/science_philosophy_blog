{% extends "base_menu.html" %}
{% load static %}
{% block title %}
    {{art.title}}
{% endblock %}

{% block content %}
<div class="row" style="width: 100%;">
<div class="col-xs-12">
    <h3>{{ art.title }}</h3>
    by: {{ art.author.username }}
    <br/>
    <br/>
    <p style="font-size: small; color: blue;">{{ art.text|safe}}</p>
    <br/>
        <hr>
    <br/>
    {% if user == art.author %}
    <a href="{% url 'arts:update_article' art.id%}"><i class="fa fa-pencil"></i></a>
    <a href="{% url 'arts:delete_article' art.id%}"><i class="fa fa-trash"></i></a>
    {% endif %}
</div>
<div class="w-100"></div>
<div id="personal" class="col-xs-12">
    {% if art.author.profile %}
        <a href="{% url 'profile_page' art.author.id %}">Profile</a> |
        {% if art.author.profile.facebook_url %}
        <a href="art.author.profile.facebook_url">Facebook</a> |
        {% endif %}
        {% if art.author.profile.twitter_url %}
        <a href="art.author.profile.twitter_url">Twitter</a> |
        {% endif %}
        {% if art.author.profile.instagram_url %}
        <a href="art.author.profile.instagram_url">Instagram</a> |
        {% endif %}
    <img src="{% static '{{art.author.profile.picture}}' %}" alt="A pic" class="rounded-circle" width="100" height="100">
    <div>
        <p>{{art.author.profile.bio| safe}}</p>
    </div>
    {% else %}
    <img src="{% static 'images/unknown_user.png' %}" alt="A pic" class="rounded-circle" width="100" height="100">
    {% endif %}
</div>
    </div>
    <form action="{% url 'arts:comment_article' art.pk %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ resp_form.as_p }}
    <input type="submit" value="Post comment">
    </form>
{% for resp in responses %}
<div style="border: solid;
    border-width: 1px;">
        <p>{{resp.response.body}}</p>
            <br>
        <p>by: {{resp.response.author }}</p>
    </div>
    <div id="response_{{resp.response.id}}">
    {% if user == resp.author %}
        <a href="{% url 'arts:update_comment' art.id resp.response.id %}">Edit</a>
        <a href="{% url 'arts:delete_comment' art.id resp.response.id %}">Delete</a>
        {% else %}
        <button class="btn btn-primary" onclick="createCommentForm({{resp.response.id}}, '{% url 'arts:delete_comment' art.id resp.response.id %}')">Comment</button>
        {% endif %}
        {% if resp.commented %}
        <a href="#" onclick="{ fetchResponses({{resp.response.id}}); return false;}"><b>show comments</b></a>
        {% endif %}
    </div>
{% endfor %}

<script>

    function getCSRFToken(){
        let cookies = document.cookie.split(";")
                .map(c => c.trim())
                .filter(c => c.startsWith("csrftoken="));
            let csrf_token = decodeURIComponent(cookies[0].split("=")[1])
            return csrf_token;
    }

    function createHeaders(){
        return {
            'Content-Type' :'application/json; charset=UTF-8',
            'X-CSRFToken' : getCSRFToken()
        }
    }

    function sendComment(id){

        let form = document.getElementById(`response_form_${id}`);

        const headers = createHeaders();

        fetch(`http://127.0.0.1:8000/articles/article/response_to_response/${id}`, {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
                'content': form.children[0].value
            })
            }).then( r => {
                console.log("Response is: " + r);
                return r.json();
            })
            .then(
                r => console.log(r.post)
            )
            .catch(error => {
                console.log(error);
            });

            form.remove()
    }

    function createCommentForm(id, url){
        let doesFormExist = !!document.getElementById(`response_form_${id}`);

        if (doesFormExist){
            return;
        }

        let current_response = document.getElementById(`response_${id}`);

        const commentForm = document.createElement("form");
        commentForm.setAttribute("method","post");
        commentForm.setAttribute("action","");
        commentForm.setAttribute("id", `response_form_${id}`)

        textArea = document.createElement("textarea");
        textArea.setAttribute("placeholder","Type your comment!");

        submit = document.createElement("input");
        submit.setAttribute("type","button");
        submit.setAttribute("value","Send");

        commentForm.appendChild(textArea);
        commentForm.appendChild(submit);

        current_response.appendChild(commentForm);
        submit.setAttribute("onclick", `sendComment(${id});return false;`);

        //sendComment(id);
    }

    function fetchResponses(id, url){
        console.log("click");
        let cid = 3
        let response_url = "{% url 'arts:all_responses_to_response' 111 %}";
        new_url= response_url.replace('111',id);
        console.log(new_url);

        fetch(new_url, {
            method : "GET"
        }).then(r => r.json())
        .then(json => json.forEach(j =>
             console.log(j)
             ))
        .catch(error => console.log(error));
    }
</script>

{% endblock %}